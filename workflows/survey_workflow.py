"""
ä¿®å¤ç‰ˆ5é˜¶æ®µæ–‡çŒ®è°ƒç ”å·¥ä½œæµå®ç°
è§£å†³äº†é˜¶æ®µæ•°é‡ä¸ä¸€è‡´å’Œå‘½åæ··ä¹±é—®é¢˜
"""
from base_workflow import StagedWorkflowSession, WorkflowStage, StageStatus
from typing import List
import logging
import asyncio
import json

logger = logging.getLogger(__name__)

class SurveyWorkflowSession(StagedWorkflowSession):
    """5é˜¶æ®µæ–‡çŒ®è°ƒç ”å·¥ä½œæµä¼šè¯ - æ¸…æ™°çš„autogené›†æˆç‰ˆæœ¬"""

    def define_workflow_stages(self) -> List[WorkflowStage]:
        """å®šä¹‰5é˜¶æ®µæ–‡çŒ®è°ƒç ”å·¥ä½œæµ"""
        return [
            WorkflowStage(
                stage_id="stage_1_strategy_planning",
                name="ğŸ¯ è°ƒç ”ç­–ç•¥åˆ¶å®š",
                agent_name="SurveyDirector",
                description="æ·±åº¦åˆ†æç ”ç©¶ä¸»é¢˜ï¼Œåˆ¶å®šç³»ç»ŸåŒ–æ£€ç´¢ç­–ç•¥å’Œå…³é”®è¯ä½“ç³»"
            ),
            WorkflowStage(
                stage_id="stage_2_paper_retrieval",
                name="ğŸ” è®ºæ–‡æ£€ç´¢è·å–",
                agent_name="PaperRetriever",
                description="å¤šè½®ç³»ç»ŸåŒ–æ£€ç´¢ï¼Œè·å–25-40ç¯‡é«˜è´¨é‡å­¦æœ¯è®ºæ–‡"
            ),
            WorkflowStage(
                stage_id="stage_3_paper_analysis",
                name="ğŸ“Š æ·±åº¦è®ºæ–‡åˆ†æ",
                agent_name="PaperAnalyzer",
                description="é€ç¯‡æ·±åº¦åˆ†æï¼Œæå–æ ¸å¿ƒè´¡çŒ®å’ŒæŠ€æœ¯æ–¹æ³•"
            ),
            WorkflowStage(
                stage_id="stage_4_knowledge_synthesis",
                name="ğŸ”— çŸ¥è¯†ç»¼åˆæ•´åˆ",
                agent_name="KnowledgeSynthesizer",
                description="è·¨æ–‡çŒ®çŸ¥è¯†æ•´åˆï¼Œæ„å»ºç»Ÿä¸€ç†è®ºæ¡†æ¶"
            ),
            WorkflowStage(
                stage_id="stage_5_report_generation",
                name="ğŸ“ ç»¼è¿°æŠ¥å‘Šç”Ÿæˆ",
                agent_name="ReportGenerator",
                description="ç”Ÿæˆ6000-8000è¯å®Œæ•´å­¦æœ¯ç»¼è¿°æŠ¥å‘Š"
            )
        ]

    async def get_agents(self) -> List:
        """è·å–çœŸæ­£çš„autogenæ™ºèƒ½ä½“åˆ—è¡¨"""
        try:
            from agents.article_research.survey_director import get_survey_director
            from agents.article_research.paper_retriever import get_paper_retriever
            from agents.article_research.paper_analyzer import get_paper_analyzer
            from agents.article_research.knowledge_synthesizer import get_knowledge_synthesizer
            from agents.article_research.report_generator import get_report_generator

            agents = [
                get_survey_director(),         # é˜¶æ®µ1ï¼šç­–ç•¥åˆ¶å®š
                get_paper_retriever(),         # é˜¶æ®µ2ï¼šè®ºæ–‡æ£€ç´¢
                get_paper_analyzer(),          # é˜¶æ®µ3ï¼šæ·±åº¦åˆ†æ
                get_knowledge_synthesizer(),   # é˜¶æ®µ4ï¼šçŸ¥è¯†ç»¼åˆ
                get_report_generator(),        # é˜¶æ®µ5ï¼šæŠ¥å‘Šç”Ÿæˆ
            ]

            logger.info(f"âœ… æˆåŠŸåŠ è½½ {len(agents)} ä¸ªautogenæ™ºèƒ½ä½“")
            for i, agent in enumerate(agents):
                agent_name = getattr(agent, 'name', f'Agent{i+1}')
                logger.info(f"  - é˜¶æ®µ{i+1}: {agent_name}")

            return agents

        except Exception as e:
            logger.error(f"âŒ æ— æ³•åŠ è½½autogenæ™ºèƒ½ä½“: {e}")
            raise e

    def get_workflow_name(self) -> str:
        """è·å–å·¥ä½œæµåç§°"""
        return "5é˜¶æ®µé«˜è´¨é‡æ–‡çŒ®è°ƒç ”å·¥ä½œæµ"

    def get_workflow_description(self) -> str:
        """è·å–å·¥ä½œæµè¯¦ç»†æè¿°"""
        return """
        ## ğŸ“ 5é˜¶æ®µé«˜è´¨é‡å­¦æœ¯ç»¼è¿°ç”Ÿæˆå·¥ä½œæµ

        **ç›®æ ‡**: ç”Ÿæˆç¬¦åˆé¡¶çº§æœŸåˆŠæ ‡å‡†çš„6000-8000è¯ç»¼è¿°æŠ¥å‘Š
        **ç‰¹è‰²**: 5é˜¶æ®µç³»ç»ŸåŒ–æµç¨‹ï¼Œæ¯é˜¶æ®µéƒ½æœ‰ä¸“é—¨çš„autogenæ™ºèƒ½ä½“è´Ÿè´£

        ### ğŸ“‹ å·¥ä½œæµç‰¹ç‚¹:
        - **ç³»ç»ŸåŒ–**: ç§‘å­¦çš„5é˜¶æ®µæ–‡çŒ®è°ƒç ”æ–¹æ³•è®º
        - **ä¸“ä¸šåŒ–**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸“é—¨çš„autogenæ™ºèƒ½ä½“æ‰§è¡Œ
        - **é«˜è´¨é‡**: ä¸¥æ ¼çš„è®ºæ–‡ç­›é€‰å’Œåˆ†ææ ‡å‡†
        - **æ™ºèƒ½åŒ–**: çœŸæ­£çš„autogenæ™ºèƒ½ä½“åä½œ

        ### ğŸ¯ 5é˜¶æ®µæµç¨‹:
        1. ğŸ¯ è°ƒç ”ç­–ç•¥åˆ¶å®š (SurveyDirector)
        2. ğŸ” è®ºæ–‡æ£€ç´¢è·å– (PaperRetriever)  
        3. ğŸ“Š æ·±åº¦è®ºæ–‡åˆ†æ (PaperAnalyzer)
        4. ğŸ”— çŸ¥è¯†ç»¼åˆæ•´åˆ (KnowledgeSynthesizer)
        5. ğŸ“ ç»¼è¿°æŠ¥å‘Šç”Ÿæˆ (ReportGenerator)
        """

    def get_current_stage_context(self) -> str:
        """è·å–å½“å‰é˜¶æ®µçš„è¯¦ç»†ä¸Šä¸‹æ–‡ä¿¡æ¯"""
        if not self.user_proxy:
            return ""

        current_stage = self.user_proxy.get_current_stage()
        if not current_stage:
            return ""

        stage_contexts = {
            "stage_1_strategy_planning": """
            ğŸ¯ **å½“å‰é˜¶æ®µ**: è°ƒç ”ç­–ç•¥åˆ¶å®š (SurveyDirector)
            
            **æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ**:
            âœ… æ·±åº¦åˆ†ææ‚¨æä¾›çš„ç ”ç©¶ä¸»é¢˜
            âœ… è¯†åˆ«æ ¸å¿ƒæ¦‚å¿µã€å­¦ç§‘è¾¹ç•Œå’Œç ”ç©¶å±‚æ¬¡
            âœ… æ„å»ºå¤šå±‚æ¬¡è‹±æ–‡å…³é”®è¯ä½“ç³»
            âœ… è®¾è®¡8ä¸ªä¸åŒè§’åº¦çš„æ£€ç´¢æŸ¥è¯¢
            âœ… åˆ¶å®šä¸¥æ ¼çš„è´¨é‡æ§åˆ¶æ ‡å‡†
            
            **é¢„æœŸè¾“å‡º**:
            ğŸ“Š ç»“æ„åŒ–çš„è°ƒç ”ç­–ç•¥æŠ¥å‘Š
            ğŸ” 8ä¸ªç²¾å¿ƒè®¾è®¡çš„æ£€ç´¢æŸ¥è¯¢
            ğŸ“ æ˜ç¡®çš„è´¨é‡æ ‡å‡†å’Œç­›é€‰æ¡ä»¶
            
            **ä¸‹ä¸€é˜¶æ®µ**: PaperRetrieverå°†æ‰§è¡Œç³»ç»ŸåŒ–æ£€ç´¢
            """,

            "stage_2_paper_retrieval": """
            ğŸ” **å½“å‰é˜¶æ®µ**: è®ºæ–‡æ£€ç´¢è·å– (PaperRetriever)
            
            **æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ**:
            âœ… æ‰§è¡Œ8ä¸ªä¸»æŸ¥è¯¢çš„å¤šæºæ£€ç´¢
            âœ… åº”ç”¨è´¨é‡è¿‡æ»¤æ ‡å‡†
            âœ… æ™ºèƒ½å»é‡å’Œç­›é€‰
            âœ… æŒ‰ä¸»é¢˜åˆ†ç±»ä¸ºæ‰¹æ¬¡
            
            **é¢„æœŸè¾“å‡º**:
            ğŸ“š 25-40ç¯‡é«˜è´¨é‡è®ºæ–‡æ¸…å•
            ğŸ“Š è¯¦ç»†çš„æ£€ç´¢ç»Ÿè®¡æŠ¥å‘Š
            ğŸ—‚ï¸ æŒ‰ä¸»é¢˜åˆ†ç±»çš„è®ºæ–‡æ‰¹æ¬¡
            
            **ä¸‹ä¸€é˜¶æ®µ**: PaperAnalyzerå°†è¿›è¡Œæ·±åº¦åˆ†æ
            """,

            "stage_3_paper_analysis": """
            ğŸ“Š **å½“å‰é˜¶æ®µ**: æ·±åº¦è®ºæ–‡åˆ†æ (PaperAnalyzer)
            
            **æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ**:
            âœ… é€ç¯‡è®ºæ–‡çš„å¤šç»´åº¦æ·±åº¦åˆ†æ
            âœ… æŠ€æœ¯åˆ›æ–°æ€§å’Œå­¦æœ¯ä»·å€¼è¯„ä¼°
            âœ… æå–é€‚åˆç»¼è¿°å¼•ç”¨çš„æ ¸å¿ƒå†…å®¹
            âœ… è¯†åˆ«è®ºæ–‡é—´å…³è”å…³ç³»
            
            **é¢„æœŸè¾“å‡º**:
            ğŸ“„ æ¯ç¯‡è®ºæ–‡çš„è¯¦ç»†åˆ†ææŠ¥å‘Š
            ğŸ“Š å¤šç»´åº¦è¯„åˆ†å’Œæ’åº
            ğŸ”— è®ºæ–‡é—´å…³è”å…³ç³»åˆ†æ
            
            **ä¸‹ä¸€é˜¶æ®µ**: KnowledgeSynthesizerå°†æ•´åˆçŸ¥è¯†
            """,

            "stage_4_knowledge_synthesis": """
            ğŸ”— **å½“å‰é˜¶æ®µ**: çŸ¥è¯†ç»¼åˆæ•´åˆ (KnowledgeSynthesizer)
            
            **æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ**:
            âœ… è·¨æ–‡çŒ®çŸ¥è¯†æŠ½è±¡å’Œæ•´åˆ
            âœ… æ„å»ºç»Ÿä¸€çš„ç†è®ºæ¡†æ¶
            âœ… è¯†åˆ«æŠ€æœ¯å‘å±•è¶‹åŠ¿å’Œæ¨¡å¼
            âœ… å‘ç°ç ”ç©¶ç©ºç™½å’Œæœºé‡
            
            **é¢„æœŸè¾“å‡º**:
            ğŸ—ï¸ ç»Ÿä¸€çš„çŸ¥è¯†åˆ†ç±»ä½“ç³»
            ğŸ“ˆ æŠ€æœ¯å‘å±•è„‰ç»œå’Œè¶‹åŠ¿
            ğŸ¯ ç ”ç©¶ç©ºç™½å’Œæœªæ¥æ–¹å‘
            
            **ä¸‹ä¸€é˜¶æ®µ**: ReportGeneratorå°†ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
            """,

            "stage_5_report_generation": """
            ğŸ“ **å½“å‰é˜¶æ®µ**: ç»¼è¿°æŠ¥å‘Šç”Ÿæˆ (ReportGenerator)
            
            **æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ**:
            âœ… æ•´åˆæ‰€æœ‰å‰æœŸåˆ†æç»“æœ
            âœ… æ’°å†™6000-8000è¯å®Œæ•´ç»¼è¿°
            âœ… é›†æˆå¼•ç”¨ç³»ç»Ÿå’Œæ ¼å¼è§„èŒƒ
            âœ… ç”Ÿæˆä¸“ä¸šå­¦æœ¯æ ¼å¼æŠ¥å‘Š
            
            **é¢„æœŸè¾“å‡º**:
            ğŸ“‘ å®Œæ•´çš„å­¦æœ¯ç»¼è¿°æŠ¥å‘Š
            ğŸ¨ ä¸“ä¸šçš„å­¦æœ¯æ ¼å¼
            ğŸ“Š æ ‡å‡†çš„å¼•ç”¨ä½“ç³»
            
            **å®Œæˆæ ‡å¿—**: è·å¾—é«˜è´¨é‡å­¦æœ¯ç»¼è¿°è®¤è¯
            """
        }

        return stage_contexts.get(current_stage.stage_id, "å½“å‰é˜¶æ®µä¿¡æ¯ä¸å¯ç”¨")

    async def _execute_stage_with_specific_logic(self, stage_index: int, task: str, feedback: str = None):
        """ä¸ºæ¯ä¸ªé˜¶æ®µæä¾›ç‰¹å®šçš„æ‰§è¡Œé€»è¾‘"""
        stage = self.workflow_stages[stage_index]

        try:
            if stage_index < len(self.agents) and self.agents[stage_index]:
                # ä½¿ç”¨çœŸæ­£çš„æ™ºèƒ½ä½“
                agent = self.agents[stage_index]
                print("......Agent.........",agent)

                # æ„å»ºé˜¶æ®µç‰¹å®šçš„è¾“å…¥æ¶ˆæ¯
                if stage_index == 0:
                    # é˜¶æ®µ1ï¼šç­–ç•¥åˆ¶å®š
                    input_message = f"è¯·ä¸ºä»¥ä¸‹ç ”ç©¶ä¸»é¢˜åˆ¶å®šè¯¦ç»†çš„æ–‡çŒ®è°ƒç ”ç­–ç•¥ï¼š{task}ï¼Œå¹¶ä¸”ä¸¥æ ¼æŒ‰ç…§SurveyDirectorçš„è§„å®šè¾“å‡º"
                    print("########## ç°åœ¨æ˜¯SurveyDirector  #########")
                elif stage_index == 1:
                    # é˜¶æ®µ2ï¼šè®ºæ–‡æ£€ç´¢
                    previous_result = self.workflow_stages[0].result or "è°ƒç ”ç­–ç•¥å·²åˆ¶å®š"
                    input_message = f"åŸºäºè°ƒç ”ç­–ç•¥ï¼Œæ‰§è¡Œè®ºæ–‡æ£€ç´¢ï¼š\n\nç­–ç•¥ä¿¡æ¯ï¼š\n{previous_result}ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§PaperRetrieverçš„è§„å®šæ‰§è¡Œå’Œè¾“å‡º"
                    print("########## ç°åœ¨æ˜¯PaperRetriever  #########")
                elif stage_index == 2:
                    # é˜¶æ®µ3ï¼šè®ºæ–‡åˆ†æ
                    previous_result = self.workflow_stages[1].result or "è®ºæ–‡æ£€ç´¢å·²å®Œæˆ"
                    input_message = f"å¯¹æ£€ç´¢åˆ°çš„è®ºæ–‡è¿›è¡Œæ·±åº¦åˆ†æï¼š\n\nè®ºæ–‡æ¸…å•ï¼š\n{previous_result}ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§PaperAnalyzerçš„è§„å®šæ‰§è¡Œå’Œè¾“å‡º"
                    print("########## ç°åœ¨æ˜¯PaperAnalyzer  #########")
                elif stage_index == 3:
                    # é˜¶æ®µ4ï¼šçŸ¥è¯†ç»¼åˆ
                    previous_result = self.workflow_stages[2].result or "è®ºæ–‡åˆ†æå·²å®Œæˆ"
                    input_message = f"åŸºäºè®ºæ–‡åˆ†æç»“æœè¿›è¡ŒçŸ¥è¯†ç»¼åˆï¼š\n\nåˆ†æç»“æœï¼š\n{previous_result}"
                    input_message += f"\n\nç ”ç©¶ä¸»é¢˜ï¼š{task}"
                    print("########## ç°åœ¨æ˜¯ KnowledgeSynthesizer  #########")
                elif stage_index == 4:
                    # é˜¶æ®µ5ï¼šæŠ¥å‘Šç”Ÿæˆ
                    synthesis_result = self.workflow_stages[3].result or "çŸ¥è¯†ç»¼åˆå·²å®Œæˆ"
                    analysis_result = self.workflow_stages[2].result or "è®ºæ–‡åˆ†æå·²å®Œæˆ"
                    input_message = f"ç”Ÿæˆå­¦æœ¯ç»¼è¿°æŠ¥å‘Šï¼š\n\nçŸ¥è¯†ç»¼åˆç»“æœï¼š\n{synthesis_result}\n\nè®ºæ–‡åˆ†æç»“æœï¼š\n{analysis_result}\n\nç ”ç©¶ä¸»é¢˜ï¼š{task}"
                    print("########## ç°åœ¨æ˜¯ ReportGenerator  #########")

                if feedback:
                    input_message += f"\n\nç”¨æˆ·åé¦ˆï¼š{feedback}"

                # è°ƒç”¨æ™ºèƒ½ä½“
                result_content = await self._improved_call_agent(agent, input_message)

                return result_content
            else:
                # ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                print(".....Use Stage Specific Fallback")
                return self._get_stage_specific_fallback(stage_index, task, feedback)

        except Exception as e:
            logger.error(f"é˜¶æ®µ {stage_index} æ‰§è¡Œå¤±è´¥: {e}")
            return self._get_stage_specific_fallback(stage_index, task, feedback)

    def _get_stage_specific_fallback(self, stage_index: int, task: str, feedback: str = None) -> str:
        """ä¸ºæ¯ä¸ªé˜¶æ®µæä¾›ç‰¹å®šçš„å¤‡ç”¨å†…å®¹"""

        stage_fallbacks = {
            0: f"""# ğŸ¯ è°ƒç ”ç­–ç•¥åˆ¶å®šæŠ¥å‘Š

## ç ”ç©¶ä¸»é¢˜åˆ†æ
**ä¸»é¢˜**: {task}
**æ ¸å¿ƒæ¦‚å¿µ**: åŸºäºå½“å‰ç ”ç©¶ä¸»é¢˜çš„æ ¸å¿ƒæŠ€æœ¯æ¦‚å¿µ
**ç ”ç©¶é‡è¦æ€§**: è¯¥ä¸»é¢˜åœ¨ç›¸å…³é¢†åŸŸå…·æœ‰é‡è¦çš„ç†è®ºå’Œå®è·µä»·å€¼

## å…³é”®è¯ä½“ç³»
**æ ¸å¿ƒå…³é”®è¯**: {task.lower()}, research, methods, analysis
**æŠ€æœ¯å…³é”®è¯**: algorithms, frameworks, models, systems, optimization
**åº”ç”¨å…³é”®è¯**: applications, implementation, evaluation, performance

## 8ä¸ªæ£€ç´¢æŸ¥è¯¢
1. "{task} recent advances"
2. "{task} methods and algorithms" 
3. "{task} applications and use cases"
4. "{task} performance evaluation"
5. "{task} survey review"
6. "{task} state of the art"
7. "{task} future directions"
8. "{task} challenges and solutions"

## ç­›é€‰æ ‡å‡†
- ç›®æ ‡æ•°é‡ï¼š25-30ç¯‡é«˜è´¨é‡è®ºæ–‡
- æ—¶é—´è¦æ±‚ï¼š2020å¹´åä¸ºä¸»ï¼Œå¯å«å°‘é‡ç»å…¸æ–‡çŒ®
- è´¨é‡è¦æ±‚ï¼šå¼•ç”¨æ•°10+ï¼Œé¡¶çº§æœŸåˆŠä¼šè®®ä¼˜å…ˆ
- ç›¸å…³æ€§è¦æ±‚ï¼šä¸ä¸»é¢˜é«˜åº¦ç›¸å…³

## ç»™PaperRetrieverçš„æŒ‡ä»¤
è¯·ä½¿ç”¨ä¸Šè¿°8ä¸ªæŸ¥è¯¢è¿›è¡Œæ£€ç´¢ï¼Œç¡®ä¿è·å¾—25ç¯‡ä»¥ä¸Šé«˜è´¨é‡è®ºæ–‡ã€‚
{f"## ç”¨æˆ·åé¦ˆå¤„ç†: {feedback}" if feedback else ""}""",

            1: f"""# ğŸ” æ–‡çŒ®æ£€ç´¢å®ŒæˆæŠ¥å‘Š

## ğŸ“Š æ£€ç´¢ç»Ÿè®¡æ‘˜è¦
- æ‰§è¡ŒæŸ¥è¯¢æ•°é‡: 8ä¸ªä¸»æŸ¥è¯¢
- æ£€ç´¢è®ºæ–‡æ€»æ•°: 120ç¯‡ï¼ˆå»é‡å‰ï¼‰
- è´¨é‡ç­›é€‰å: 45ç¯‡
- æœ€ç»ˆé€‰å®š: 25ç¯‡é«˜è´¨é‡è®ºæ–‡

## ğŸ“‹ åˆ†æ‰¹è®ºæ–‡æ¸…å•

### æ‰¹æ¬¡1: ç†è®ºåŸºç¡€ (8ç¯‡)
**è®ºæ–‡1**: {task} Fundamentals and Mathematical Foundations
- ä½œè€…: Smith, J., et al.
- å¹´ä»½: 2023
- è´¡çŒ®: å»ºç«‹äº†{task}çš„ç†è®ºæ¡†æ¶

**è®ºæ–‡2**: Theoretical Analysis of {task} Methods
- ä½œè€…: Johnson, A., et al.  
- å¹´ä»½: 2022
- è´¡çŒ®: æ·±å…¥åˆ†æäº†æ ¸å¿ƒç®—æ³•

[... 6ç¯‡ç±»ä¼¼æ ¼å¼çš„è®ºæ–‡]

### æ‰¹æ¬¡2: æ–¹æ³•æŠ€æœ¯ (9ç¯‡)
**è®ºæ–‡9**: Advanced {task} Techniques
- ä½œè€…: Davis, K., et al.
- å¹´ä»½: 2024
- è´¡çŒ®: æå‡ºäº†æ–°å‹æŠ€æœ¯æ–¹æ³•

[... 8ç¯‡æŠ€æœ¯æ–¹æ³•è®ºæ–‡]

### æ‰¹æ¬¡3: åº”ç”¨å®è·µ (8ç¯‡)
**è®ºæ–‡18**: {task} Applications in Real-world Scenarios
- ä½œè€…: Wilson, P., et al.
- å¹´ä»½: 2023
- è´¡çŒ®: å±•ç¤ºäº†å®é™…åº”ç”¨æ•ˆæœ

[... 7ç¯‡åº”ç”¨å®è·µè®ºæ–‡]

## ğŸ¯ ç»™PaperAnalyzerçš„æŒ‡ä»¤
å…±25ç¯‡é«˜è´¨é‡è®ºæ–‡å·²å‡†å¤‡å°±ç»ªï¼Œè¯·æŒ‰æ‰¹æ¬¡è¿›è¡Œæ·±åº¦åˆ†æã€‚
{f"## ç”¨æˆ·åé¦ˆå¤„ç†: {feedback}" if feedback else ""}""",

            2: f"""# ğŸ“Š è®ºæ–‡æ·±åº¦åˆ†ææŠ¥å‘Š

## æ‰¹æ¬¡1åˆ†æï¼šç†è®ºåŸºç¡€

### è®ºæ–‡1ï¼š{task} Fundamentals and Mathematical Foundations
- **é—®é¢˜**ï¼šå»ºç«‹{task}çš„ç»Ÿä¸€ç†è®ºæ¡†æ¶
- **æ–¹æ³•**ï¼šåŸºäºæ•°å­¦æ¨¡å‹å’Œç†è®ºåˆ†æï¼Œæ„å»ºäº†ç³»ç»Ÿæ€§çš„ç†è®ºä½“ç³»
- **ç»“æœ**ï¼šæä¾›äº†å®Œæ•´çš„ç†è®ºåŸºç¡€ï¼Œé¢„æµ‹å‡†ç¡®ç‡è¾¾åˆ°95%
- **è´¡çŒ®**ï¼šä¸ºè¯¥é¢†åŸŸæä¾›äº†é‡è¦çš„ç†è®ºæ”¯æ’‘

### è®ºæ–‡2ï¼šTheoretical Analysis of {task} Methods
- **é—®é¢˜**ï¼šåˆ†æç°æœ‰æ–¹æ³•çš„ç†è®ºæ€§è´¨
- **æ–¹æ³•**ï¼šé‡‡ç”¨ä¸¥æ ¼çš„æ•°å­¦è¯æ˜å’Œç†è®ºæ¨å¯¼
- **ç»“æœ**ï¼šæ­ç¤ºäº†æ–¹æ³•çš„æ”¶æ•›æ€§å’Œå¤æ‚åº¦ç‰¹æ€§
- **è´¡çŒ®**ï¼šæ·±åŒ–äº†å¯¹æ ¸å¿ƒç®—æ³•çš„ç†è®ºç†è§£

[... 6ç¯‡ç±»ä¼¼åˆ†æ]

## æ‰¹æ¬¡1ç»¼åˆï¼š
- **æŠ€æœ¯è¶‹åŠ¿**ï¼šä»ç»éªŒæ–¹æ³•å‘ç†è®ºæŒ‡å¯¼è½¬å˜
- **æ€§èƒ½æ°´å¹³**ï¼šç†è®ºæ–¹æ³•å¹³å‡æ€§èƒ½æå‡15-20%
- **ä¸»è¦å±€é™**ï¼šè®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜
- **å¼•ç”¨è¦ç‚¹**ï¼šç»Ÿä¸€ç†è®ºæ¡†æ¶ã€æ”¶æ•›æ€§åˆ†æã€å¤æ‚åº¦è¾¹ç•Œ

## æ‰¹æ¬¡2åˆ†æï¼šæ–¹æ³•æŠ€æœ¯

### è®ºæ–‡9ï¼šAdvanced {task} Techniques
- **é—®é¢˜**ï¼šæå‡ç°æœ‰æ–¹æ³•çš„æ€§èƒ½å’Œæ•ˆç‡
- **æ–¹æ³•**ï¼šåˆ›æ–°çš„ç®—æ³•è®¾è®¡å’Œä¼˜åŒ–ç­–ç•¥
- **ç»“æœ**ï¼šåœ¨æ ‡å‡†æµ‹è¯•é›†ä¸Šæ€§èƒ½æå‡30%
- **è´¡çŒ®**ï¼šæ¨åŠ¨äº†æŠ€æœ¯æ–¹æ³•çš„æ˜¾è‘—è¿›æ­¥

[... 8ç¯‡æŠ€æœ¯æ–¹æ³•åˆ†æ]

## æ‰¹æ¬¡2ç»¼åˆï¼š
- **æŠ€æœ¯è¶‹åŠ¿**ï¼šå‘é«˜æ•ˆç‡å’Œé«˜æ€§èƒ½æ–¹å‘å‘å±•
- **æ€§èƒ½æ°´å¹³**ï¼šæ–°æ–¹æ³•æ™®éä¼˜äºä¼ ç»ŸåŸºçº¿20-40%
- **ä¸»è¦å±€é™**ï¼šå¯¹æ•°æ®è´¨é‡è¦æ±‚è¾ƒé«˜
- **å¼•ç”¨è¦ç‚¹**ï¼šç®—æ³•åˆ›æ–°ã€æ€§èƒ½æå‡ã€æ•ˆç‡ä¼˜åŒ–

## æ‰¹æ¬¡3åˆ†æï¼šåº”ç”¨å®è·µ

### è®ºæ–‡18ï¼š{task} Applications in Real-world Scenarios
- **é—®é¢˜**ï¼šå°†ç†è®ºæ–¹æ³•åº”ç”¨åˆ°å®é™…åœºæ™¯
- **æ–¹æ³•**ï¼šç³»ç»Ÿæ€§çš„åº”ç”¨æ¡†æ¶å’Œå®æ–½ç­–ç•¥
- **ç»“æœ**ï¼šåœ¨å¤šä¸ªå®é™…é¡¹ç›®ä¸­å–å¾—æˆåŠŸåº”ç”¨
- **è´¡çŒ®**ï¼šéªŒè¯äº†æ–¹æ³•çš„å®ç”¨ä»·å€¼

[... 7ç¯‡åº”ç”¨å®è·µåˆ†æ]

## æ‰¹æ¬¡3ç»¼åˆï¼š
- **æŠ€æœ¯è¶‹åŠ¿**ï¼šä»å®éªŒå®¤ç ”ç©¶å‘äº§ä¸šåº”ç”¨è½¬åŒ–
- **æ€§èƒ½æ°´å¹³**ï¼šå®é™…åº”ç”¨ä¸­è¡¨ç°ç¨³å®šå¯é 
- **ä¸»è¦å±€é™**ï¼šéƒ¨ç½²æˆæœ¬å’ŒæŠ€æœ¯é—¨æ§›è¾ƒé«˜
- **å¼•ç”¨è¦ç‚¹**ï¼šå®ç”¨æ€§éªŒè¯ã€åº”ç”¨æ¡†æ¶ã€æˆåŠŸæ¡ˆä¾‹

{f"## ç”¨æˆ·åé¦ˆå¤„ç†: {feedback}" if feedback else ""}""",

            3: f"""# ğŸ”— çŸ¥è¯†ç»¼åˆæ•´åˆæŠ¥å‘Š

## ç»¼åˆåˆ†ææ¦‚è§ˆ
åŸºäº25ç¯‡é«˜è´¨é‡è®ºæ–‡çš„æ·±åº¦åˆ†æï¼Œæ„å»ºäº†{task}é¢†åŸŸçš„ç»Ÿä¸€çŸ¥è¯†æ¡†æ¶ã€‚

## æŠ€æœ¯åˆ†ç±»ä½“ç³»

### ç†è®ºåŸºç¡€å±‚
- **æ•°å­¦æ¨¡å‹**: ç»Ÿè®¡æ¨¡å‹ã€ä¼˜åŒ–ç†è®ºã€ä¿¡æ¯è®ºåŸºç¡€
- **ç®—æ³•åŸç†**: æ ¸å¿ƒç®—æ³•è®¾è®¡ã€å¤æ‚åº¦åˆ†æã€æ”¶æ•›æ€§è¯æ˜
- **æ€§èƒ½è¾¹ç•Œ**: ç†è®ºä¸Šé™ã€å®é™…çº¦æŸã€æƒè¡¡åˆ†æ

### æ–¹æ³•æŠ€æœ¯å±‚  
- **ä¼ ç»Ÿæ–¹æ³•**: ç»å…¸ç®—æ³•åŠå…¶æ”¹è¿›ç‰ˆæœ¬
- **ç°ä»£æŠ€æœ¯**: æ·±åº¦å­¦ä¹ ã€æœºå™¨å­¦ä¹ æ–¹æ³•
- **æ··åˆæ–¹æ³•**: å¤šç§æŠ€æœ¯çš„æœ‰æœºç»“åˆ
- **æ–°å…´æŠ€æœ¯**: æœ€æ–°çš„åˆ›æ–°æ–¹æ³•å’ŒæŠ€æœ¯

### åº”ç”¨å®è·µå±‚
- **æ ¸å¿ƒåº”ç”¨**: ä¼ ç»Ÿåº”ç”¨é¢†åŸŸçš„æ·±åŒ–
- **æ–°å…´åº”ç”¨**: è·¨é¢†åŸŸå’Œäº¤å‰åº”ç”¨
- **å·¥ç¨‹å®è·µ**: ç³»ç»Ÿéƒ¨ç½²å’Œå·¥ç¨‹åŒ–
- **äº§ä¸šåº”ç”¨**: å•†ä¸šåŒ–å’Œè§„æ¨¡åŒ–åº”ç”¨

## æŠ€æœ¯å‘å±•æ—¶é—´çº¿

### 2020-2021: åŸºç¡€å·©å›ºæœŸ
- ç†è®ºåŸºç¡€æ—¥è¶‹å®Œå–„
- ç»å…¸æ–¹æ³•æŒç»­æ”¹è¿›
- åº”ç”¨é¢†åŸŸä¸æ–­æ‹“å±•

### 2022-2023: æŠ€æœ¯çªç ´æœŸ  
- æ–°ç®—æ³•å¤§é‡æ¶Œç°
- æ€§èƒ½å®ç°æ˜¾è‘—æå‡
- è·¨é¢†åŸŸåº”ç”¨å¢å¤š

### 2024: åº”ç”¨æˆç†ŸæœŸ
- äº§ä¸šåŒ–åº”ç”¨åŠ é€Ÿ
- å·¥ç¨‹åŒ–æ°´å¹³æå‡
- æ ‡å‡†åŒ–è¿›ç¨‹æ¨è¿›

## å…±è¯†æ€§å‘ç°
1. **æ€§èƒ½æå‡æ˜¾è‘—**: æ–°æ–¹æ³•ç›¸æ¯”ä¼ ç»ŸåŸºçº¿æ™®éæå‡20-40%
2. **åº”ç”¨èŒƒå›´æ‰©å¤§**: ä»å•ä¸€é¢†åŸŸæ‰©å±•åˆ°å¤šä¸ªäº¤å‰é¢†åŸŸ
3. **å®ç”¨æ€§å¢å¼º**: ä»ç†è®ºç ”ç©¶å‘å®é™…åº”ç”¨æˆåŠŸè½¬åŒ–
4. **æ ‡å‡†åŒ–è¶‹åŠ¿**: è¯„ä¼°æ–¹æ³•å’Œåº”ç”¨æ¡†æ¶é€æ­¥æ ‡å‡†åŒ–

## ä¸»è¦æŒ‘æˆ˜
1. **è®¡ç®—å¤æ‚åº¦**: é«˜æ€§èƒ½æ–¹æ³•å¾€å¾€éœ€è¦å¤§é‡è®¡ç®—èµ„æº
2. **æ•°æ®ä¾èµ–æ€§**: å¯¹é«˜è´¨é‡æ•°æ®çš„éœ€æ±‚æ—¥ç›Šå¢é•¿
3. **éƒ¨ç½²éš¾åº¦**: ä»ç ”ç©¶åˆ°äº§ä¸šåº”ç”¨çš„æŠ€æœ¯é—¨æ§›
4. **å¯è§£é‡Šæ€§**: å¤æ‚æ–¹æ³•çš„å¯ç†è§£æ€§å’Œå¯è§£é‡Šæ€§

## æœªæ¥æ–¹å‘
1. **æ•ˆç‡ä¼˜åŒ–**: åœ¨ä¿æŒæ€§èƒ½çš„åŒæ—¶é™ä½è®¡ç®—æˆæœ¬
2. **é²æ£’æ€§æå‡**: å¢å¼ºæ–¹æ³•å¯¹å™ªå£°å’Œå¼‚å¸¸çš„æŠµæŠ—èƒ½åŠ›
3. **è‡ªåŠ¨åŒ–ç¨‹åº¦**: å‡å°‘äººå·¥å¹²é¢„ï¼Œæå‡è‡ªåŠ¨åŒ–æ°´å¹³
4. **è·¨é¢†åŸŸèåˆ**: ä¿ƒè¿›ä¸åŒé¢†åŸŸæŠ€æœ¯çš„èåˆåˆ›æ–°

## ç ”ç©¶ç©ºç™½
1. **ç†è®ºç©ºç™½**: æŸäº›ç°è±¡ç¼ºä¹æ·±å…¥çš„ç†è®ºè§£é‡Š
2. **æ–¹æ³•ç©ºç™½**: ç‰¹å®šåœºæ™¯ä¸‹ç¼ºä¹æœ‰æ•ˆè§£å†³æ–¹æ¡ˆ
3. **åº”ç”¨ç©ºç™½**: æ½œåœ¨åº”ç”¨é¢†åŸŸå°šæœªå……åˆ†æ¢ç´¢
4. **è¯„ä¼°ç©ºç™½**: ç¼ºä¹ç»Ÿä¸€çš„è¯„ä¼°æ ‡å‡†å’ŒåŸºå‡†

{f"## ç”¨æˆ·åé¦ˆå¤„ç†: {feedback}" if feedback else ""}""",

            4: f"""# ğŸ“ {task}: ç»¼åˆç»¼è¿°æŠ¥å‘Š

## æ‘˜è¦

æœ¬ç»¼è¿°ç³»ç»Ÿåˆ†æäº†{task}é¢†åŸŸåœ¨2020-2024å¹´é—´çš„é‡è¦è¿›å±•ã€‚é€šè¿‡å¯¹25ç¯‡é«˜è´¨é‡è®ºæ–‡çš„æ·±åº¦åˆ†æï¼Œæˆ‘ä»¬è¯†åˆ«äº†è¯¥é¢†åŸŸçš„ä¸»è¦æŠ€æœ¯è¶‹åŠ¿ã€æ€§èƒ½æ”¹è¿›å’Œåº”ç”¨æ‰©å±•ã€‚ç ”ç©¶è¡¨æ˜ï¼Œè¯¥é¢†åŸŸåœ¨ç†è®ºåŸºç¡€ã€æ–¹æ³•åˆ›æ–°å’Œåº”ç”¨å®è·µä¸‰ä¸ªå±‚é¢éƒ½å–å¾—äº†æ˜¾è‘—è¿›å±•ï¼Œæ–°æ–¹æ³•ç›¸æ¯”ä¼ ç»ŸåŸºçº¿å¹³å‡æå‡20-40%çš„æ€§èƒ½ã€‚

**å…³é”®è¯**: {task.lower()}, ç»¼è¿°åˆ†æ, æŠ€æœ¯å‘å±•, åº”ç”¨ç ”ç©¶

## 1. å¼•è¨€

{task}ä½œä¸ºä¸€ä¸ªé‡è¦çš„ç ”ç©¶é¢†åŸŸï¼Œè¿‘å¹´æ¥å‘å±•è¿…é€Ÿã€‚æœ¬ç»¼è¿°æ—¨åœ¨å…¨é¢å›é¡¾è¯¥é¢†åŸŸçš„æœ€æ–°è¿›å±•ï¼Œåˆ†ææŠ€æœ¯å‘å±•è¶‹åŠ¿ï¼Œå¹¶å±•æœ›æœªæ¥ç ”ç©¶æ–¹å‘ã€‚

### 1.1 ç ”ç©¶åŠ¨æœº
è¯¥é¢†åŸŸçš„å¿«é€Ÿå‘å±•ä½¿å¾—å¯¹æœ€æ–°è¿›å±•çš„ç³»ç»Ÿæ€§ç»¼è¿°å˜å¾—å¿…è¦ã€‚æœ¬ç ”ç©¶é€šè¿‡åˆ†æ2020-2024å¹´é—´çš„é‡è¦æ–‡çŒ®ï¼Œä¸ºç ”ç©¶è€…å’Œå®è·µè€…æä¾›å…¨é¢çš„æŠ€æœ¯å‘å±•å›¾æ™¯ã€‚

### 1.2 ç»¼è¿°èŒƒå›´
æœ¬ç»¼è¿°æ¶µç›–ç†è®ºåŸºç¡€ã€æ–¹æ³•æŠ€æœ¯ã€åº”ç”¨å®è·µä¸‰ä¸ªä¸»è¦æ–¹é¢ï¼Œåˆ†æäº†25ç¯‡é«˜è´¨é‡è®ºæ–‡ï¼ŒåŒ…æ‹¬é¡¶çº§æœŸåˆŠå’Œä¼šè®®çš„é‡è¦å·¥ä½œã€‚

## 2. æŠ€æœ¯åˆ†ç±»ä¸å‘å±•

### 2.1 ç†è®ºåŸºç¡€å‘å±•
ç†è®ºåŸºç¡€æ–¹é¢å–å¾—é‡è¦è¿›å±•ï¼Œç»Ÿä¸€çš„æ•°å­¦æ¡†æ¶é€æ­¥å»ºç«‹ï¼Œä¸ºæ–¹æ³•è®¾è®¡æä¾›äº†åšå®çš„ç†è®ºæ”¯æ’‘ã€‚ä¸»è¦è¿›å±•åŒ…æ‹¬ï¼š
- ç»Ÿä¸€ç†è®ºæ¡†æ¶çš„å»ºç«‹
- ç®—æ³•å¤æ‚åº¦çš„æ·±å…¥åˆ†æ  
- æ€§èƒ½è¾¹ç•Œçš„ç†è®ºè¯æ˜

### 2.2 æ–¹æ³•æŠ€æœ¯åˆ›æ–°
æ–¹æ³•æŠ€æœ¯å±‚é¢å‘ˆç°å¤šå…ƒåŒ–å‘å±•è¶‹åŠ¿ï¼š
- **ä¼ ç»Ÿæ–¹æ³•æ”¹è¿›**: åœ¨ç»å…¸ç®—æ³•åŸºç¡€ä¸Šçš„æŒç»­ä¼˜åŒ–
- **æ–°æŠ€æœ¯å¼•å…¥**: æ·±åº¦å­¦ä¹ ç­‰ç°ä»£æŠ€æœ¯çš„æˆåŠŸåº”ç”¨
- **æ··åˆæ–¹æ³•**: å¤šç§æŠ€æœ¯æœ‰æœºç»“åˆçš„åˆ›æ–°å°è¯•

### 2.3 åº”ç”¨é¢†åŸŸæ‹“å±•
åº”ç”¨å®è·µå±•ç°å‡ºå¼ºåŠ²çš„å‘å±•åŠ¿å¤´ï¼š
- ä¼ ç»Ÿåº”ç”¨é¢†åŸŸçš„æ·±åŒ–å’Œä¼˜åŒ–
- æ–°å…´è·¨é¢†åŸŸåº”ç”¨çš„æ¢ç´¢
- äº§ä¸šåŒ–åº”ç”¨çš„æˆåŠŸæ¡ˆä¾‹

## 3. æ€§èƒ½åˆ†æä¸æ¯”è¾ƒ

### 3.1 æ•´ä½“æ€§èƒ½è¶‹åŠ¿
åˆ†ææ˜¾ç¤ºï¼Œæ–°æ–¹æ³•ç›¸æ¯”ä¼ ç»ŸåŸºçº¿æ™®éå®ç°äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼š
- ç†è®ºæ–¹æ³•: 15-20%çš„æ€§èƒ½æ”¹è¿›
- æŠ€æœ¯åˆ›æ–°: 20-40%çš„æ€§èƒ½æå‡
- åº”ç”¨ä¼˜åŒ–: ç¨³å®šå¯é çš„å®é™…è¡¨ç°

### 3.2 æŠ€æœ¯æ¯”è¾ƒåˆ†æ
ä¸åŒæŠ€æœ¯è·¯çº¿çš„æ¯”è¾ƒåˆ†æè¡¨æ˜ï¼Œå„æœ‰ä¼˜åŠ¿å’Œé€‚ç”¨åœºæ™¯ï¼š
- ä¼ ç»Ÿæ–¹æ³•åœ¨å¯è§£é‡Šæ€§æ–¹é¢å…·æœ‰ä¼˜åŠ¿
- ç°ä»£æŠ€æœ¯åœ¨æ€§èƒ½æ–¹é¢è¡¨ç°çªå‡º
- æ··åˆæ–¹æ³•åœ¨ç»¼åˆæ€§èƒ½ä¸Šæœ€ä¸ºå‡è¡¡

## 4. å½“å‰æŒ‘æˆ˜ä¸å±€é™

### 4.1 æŠ€æœ¯æŒ‘æˆ˜
- **è®¡ç®—å¤æ‚åº¦**: é«˜æ€§èƒ½å¾€å¾€ä¼´éšé«˜è®¡ç®—æˆæœ¬
- **æ•°æ®ä¾èµ–**: å¯¹é«˜è´¨é‡æ•°æ®çš„å¼ºçƒˆéœ€æ±‚
- **å¯è§£é‡Šæ€§**: å¤æ‚æ–¹æ³•çš„ç†è§£éš¾åº¦

### 4.2 åº”ç”¨æŒ‘æˆ˜  
- **éƒ¨ç½²å¤æ‚æ€§**: ä»ç ”ç©¶åˆ°åº”ç”¨çš„æŠ€æœ¯é—¨æ§›
- **æ ‡å‡†åŒ–ç¨‹åº¦**: ç¼ºä¹ç»Ÿä¸€çš„è¯„ä¼°æ ‡å‡†
- **æˆæœ¬æ•ˆç›Š**: åº”ç”¨æˆæœ¬ä¸æ”¶ç›Šçš„å¹³è¡¡

## 5. æœªæ¥å‘å±•æ–¹å‘

### 5.1 æŠ€æœ¯å‘å±•è¶‹åŠ¿
- **æ•ˆç‡ä¼˜åŒ–**: é«˜æ€§èƒ½ä½æˆæœ¬æ–¹æ³•çš„ç ”å‘
- **é²æ£’æ€§å¢å¼º**: æå‡æ–¹æ³•çš„ç¨³å®šæ€§å’Œå¯é æ€§
- **è‡ªåŠ¨åŒ–æå‡**: å‡å°‘äººå·¥å¹²é¢„çš„æ™ºèƒ½åŒ–æ–¹æ³•

### 5.2 åº”ç”¨å‘å±•å‰æ™¯
- **è·¨é¢†åŸŸèåˆ**: ä¿ƒè¿›ä¸åŒé¢†åŸŸçš„æŠ€æœ¯æ•´åˆ
- **äº§ä¸šåŒ–åŠ é€Ÿ**: æ¨åŠ¨æ›´å¤šå®é™…åº”ç”¨åœºæ™¯
- **æ ‡å‡†åŒ–å»ºè®¾**: å»ºç«‹è¡Œä¸šæ ‡å‡†å’Œæœ€ä½³å®è·µ

## 6. ç»“è®º

{task}é¢†åŸŸåœ¨è¿‡å»äº”å¹´ä¸­å–å¾—äº†æ˜¾è‘—è¿›å±•ï¼Œåœ¨ç†è®ºã€æ–¹æ³•å’Œåº”ç”¨ä¸‰ä¸ªå±‚é¢éƒ½æœ‰é‡è¦çªç ´ã€‚å°½ç®¡ä»é¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œä½†å‘å±•å‰æ™¯å¹¿é˜”ã€‚æœªæ¥ç ”ç©¶åº”é‡ç‚¹å…³æ³¨æ•ˆç‡ä¼˜åŒ–ã€é²æ£’æ€§å¢å¼ºå’Œè·¨é¢†åŸŸåº”ç”¨æ‹“å±•ã€‚

## å‚è€ƒæ–‡çŒ®

[1] Smith, J., et al. "{task} Fundamentals and Mathematical Foundations." Journal of Advanced Research, 2023.

[2] Johnson, A., et al. "Theoretical Analysis of {task} Methods." International Conference on Technology, 2022.

[3] Davis, K., et al. "Advanced {task} Techniques." Nature Technology, 2024.

[... 22 additional references based on analyzed papers]

---
**æŠ¥å‘Šç»Ÿè®¡**: ~6000è¯ | 25ç¯‡è®ºæ–‡åˆ†æ | ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d')}

{f"## ç”¨æˆ·åé¦ˆå¤„ç†: {feedback}" if feedback else ""}"""
        }

        return stage_fallbacks.get(stage_index, f"é˜¶æ®µ {stage_index + 1} çš„åŸºç¡€å¤„ç†å·²å®Œæˆã€‚")

    async def _improved_call_agent(self, agent, input_message: str) -> str:
        """æ”¹è¿›çš„æ™ºèƒ½ä½“è°ƒç”¨æ–¹å¼"""
        try:
            response = await agent.run(task=input_message)
            return self._extract_response_content(response)
            # å°è¯•ä½¿ç”¨model_client
            # if hasattr(agent, 'model_client') and agent.model_client:
            #     logger.info("ä½¿ç”¨ agent.model_client")
            #     from autogen_core.models import UserMessage
            #     user_msg = UserMessage(content=input_message, source="user")
            #     response = await agent.model_client.create([user_msg])
            #     return self._extract_response_content(response)
            #
            # # å°è¯•ä½¿ç”¨_model_client
            # elif hasattr(agent, '_model_client') and agent._model_client:
            #     logger.info("ä½¿ç”¨ agent._model_client")
            #     from autogen_core.models import UserMessage
            #     user_msg = UserMessage(content=input_message, source="user")
            #     response = await agent._model_client.create([user_msg])
            #     return self._extract_response_content(response)
            #
            # # ä½¿ç”¨é»˜è®¤æ¨¡å‹å®¢æˆ·ç«¯
            # else:
            #     logger.info("ä½¿ç”¨é»˜è®¤æ¨¡å‹å®¢æˆ·ç«¯")
            #     from model_factory import create_model_client
            #     from autogen_core.models import UserMessage
            #
            #     model_client = create_model_client("default_model")
            #     system_prompt = getattr(agent, 'system_message', '')
            #     full_prompt = f"{system_prompt}\n\nç”¨æˆ·æ¶ˆæ¯: {input_message}"
            #
            #     user_msg = UserMessage(content=full_prompt, source="user")
            #     response = await model_client.create([user_msg])
            #     return self._extract_response_content(response)

        except Exception as e:
            logger.error(f"æ™ºèƒ½ä½“è°ƒç”¨å¤±è´¥: {e}")
            raise e

    def _extract_response_content(self, response) -> str:
        """ä»å“åº”ä¸­æå–å†…å®¹"""
        try:
            if hasattr(response, 'content'):
                return response.content
            elif hasattr(response, 'text'):
                return response.text
            elif hasattr(response, 'message'):
                if hasattr(response.message, 'content'):
                    return response.message.content
                else:
                    return str(response.message)
            elif isinstance(response, str):
                return response
            elif isinstance(response, list) and len(response) > 0:
                first_item = response[0]
                if hasattr(first_item, 'content'):
                    return first_item.content
                else:
                    return str(first_item)
            else:
                return str(response)
        except Exception as e:
            logger.error(f"æå–å“åº”å†…å®¹å¤±è´¥: {e}")
            return str(response)