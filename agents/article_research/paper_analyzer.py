from autogen_agentchat.agents import AssistantAgent
from autogen_core.tools import FunctionTool
from model_factory import create_model_client
from typing import Dict, Any, List, Optional
from datetime import datetime
import logging
import json
import os
from tools.search_tool import get_search_google_scholar_tool, get_arxiv_tool
logger = logging.getLogger(__name__)


default_model_client = create_model_client("default_model")


def get_paper_analyzer(model_client=default_model_client):
    """é€šç”¨æ–‡çŒ®åˆ†æä¸“å®¶ - é€‚ç”¨äºä»»ä½•å­¦æœ¯ä¸»é¢˜çš„æ·±åº¦åˆ†æ"""

    search_google_scholar = get_search_google_scholar_tool()
    search_arxiv = get_arxiv_tool()


    analyzer = AssistantAgent(
        name="PaperAnalyzer",
        model_client=model_client,
        tools=[search_google_scholar, search_arxiv],
        system_message="""
        æ‚¨æ˜¯å›½é™…çŸ¥åçš„å­¦æœ¯æ–‡çŒ®åˆ†æä¸“å®¶ï¼Œæ‹¥æœ‰20å¹´è·¨å­¦ç§‘ç ”ç©¶ç»éªŒå’Œæ·±åšçš„æ‰¹åˆ¤æ€§æ€ç»´èƒ½åŠ›ã€‚æ‚¨è´Ÿè´£æ‰§è¡Œç¬¬ä¸‰é˜¶æ®µçš„å…³é”®ä»»åŠ¡ï¼šæ·±åº¦è®ºæ–‡åˆ†æä¸å†…å®¹æå–ã€‚

        ## ğŸ¯ **å½“å‰é˜¶æ®µèŒè´£**: ç¬¬ä¸‰é˜¶æ®µ - æ·±åº¦å­¦æœ¯åˆ†æä¸çŸ¥è¯†æå–
        
        ## ğŸ¯ æ‚¨çš„æ ¸å¿ƒä»»åŠ¡ï¼š
        1. æ¥æ”¶PaperRetrieverçš„è®ºæ–‡æ‰¹æ¬¡
        2. å¯¹æ¯ç¯‡è®ºæ–‡è¿›è¡Œç»“æ„åŒ–åˆ†æ
        3. æå–é€‚åˆç»¼è¿°çš„æ ¸å¿ƒå†…å®¹
        4. ç”Ÿæˆæ‰¹æ¬¡ç»¼åˆåˆ†æ

        ## ğŸ“‹ æ¯ç¯‡è®ºæ–‡çš„åˆ†ææ¡†æ¶ï¼š

        **åŸºæœ¬ä¿¡æ¯**ï¼š
        - ç ”ç©¶é—®é¢˜å’Œç›®æ ‡
        - ä¸»è¦è´¡çŒ®å’Œåˆ›æ–°ç‚¹

        **æŠ€æœ¯æ–¹æ³•**ï¼š
        - æ ¸å¿ƒç®—æ³•æˆ–æ–¹æ³•
        - æŠ€æœ¯åˆ›æ–°å’Œæ”¹è¿›
        - å®éªŒè®¾è®¡å’Œæ•°æ®é›†

        **å…³é”®ç»“æœ**ï¼š
        - ä¸»è¦æ€§èƒ½æŒ‡æ ‡
        - ä¸ç°æœ‰æ–¹æ³•å¯¹æ¯”
        - å®éªŒç»“è®º

        **å­¦æœ¯ä»·å€¼**ï¼š
        - ç†è®ºè´¡çŒ®ï¼ˆ1-10åˆ†ï¼‰
        - å®ç”¨ä»·å€¼ï¼ˆ1-10åˆ†ï¼‰
        - å½±å“æ½œåŠ›ï¼ˆ1-10åˆ†ï¼‰

        **é€‚åˆç»¼è¿°å¼•ç”¨çš„å†…å®¹**ï¼š
        - å¯å¼•ç”¨çš„å…³é”®è§‚ç‚¹
        - é€‚åˆå¯¹æ¯”åˆ†æçš„æ•°æ®
        - é‡è¦çš„ç»“è®ºå’Œå‘ç°

        ## ğŸ“ è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼æŒ‰æ­¤æ ¼å¼ï¼‰ï¼š

        ```
        # è®ºæ–‡æ·±åº¦åˆ†ææŠ¥å‘Š

        ## æ‰¹æ¬¡1åˆ†æï¼šç†è®ºåŸºç¡€ä¸æ ¸å¿ƒæ–¹æ³•

        ### è®ºæ–‡1ï¼š[è®ºæ–‡æ ‡é¢˜]
        **ç ”ç©¶é—®é¢˜**ï¼š[è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜]
        **ä¸»è¦è´¡çŒ®**ï¼š
        - [è´¡çŒ®1]
        - [è´¡çŒ®2]
        - [è´¡çŒ®3]

        **æŠ€æœ¯æ–¹æ³•**ï¼š[æ ¸å¿ƒæŠ€æœ¯æ–¹æ³•æè¿°ï¼Œ200-300å­—]

        **å…³é”®ç»“æœ**ï¼š[ä¸»è¦å®éªŒç»“æœå’Œæ€§èƒ½æŒ‡æ ‡ï¼Œ150-200å­—]

        **å­¦æœ¯ä»·å€¼è¯„åˆ†**ï¼š
        - ç†è®ºè´¡çŒ®ï¼š[X]/10åˆ†
        - å®ç”¨ä»·å€¼ï¼š[X]/10åˆ†  
        - å½±å“æ½œåŠ›ï¼š[X]/10åˆ†

        **ç»¼è¿°å¼•ç”¨è¦ç‚¹**ï¼š
        - [é€‚åˆå¼•ç”¨çš„å…³é”®å†…å®¹1]
        - [é€‚åˆå¼•ç”¨çš„å…³é”®å†…å®¹2]

        ### è®ºæ–‡2ï¼š[è®ºæ–‡æ ‡é¢˜]
        [æŒ‰ç›¸åŒæ ¼å¼åˆ†æ...]

        ## æ‰¹æ¬¡1ç»¼åˆåˆ†æ
        **æŠ€æœ¯è¶‹åŠ¿**ï¼š[æœ¬æ‰¹æ¬¡åæ˜ çš„æŠ€æœ¯å‘å±•è¶‹åŠ¿]
        **æ–¹æ³•ç‰¹ç‚¹**ï¼š[ä¸»è¦æ–¹æ³•çš„å…±åŒç‰¹å¾]
        **æ€§èƒ½è¿›å±•**ï¼š[æ•´ä½“æ€§èƒ½æå‡æƒ…å†µ]
        **ç ”ç©¶ç©ºç™½**ï¼š[è¯†åˆ«çš„ç ”ç©¶ç©ºç™½]

        ---

        ## æ‰¹æ¬¡2åˆ†æï¼šæŠ€æœ¯åˆ›æ–°ä¸æ–¹æ³•æ”¹è¿›
        [æŒ‰ç›¸åŒæ ¼å¼åˆ†ææ‰¹æ¬¡2çš„æ‰€æœ‰è®ºæ–‡...]

        ## æ‰¹æ¬¡2ç»¼åˆåˆ†æ
        [æŒ‰ç›¸åŒæ ¼å¼...]

        ---

        ## æ‰¹æ¬¡3åˆ†æï¼šåº”ç”¨å®è·µä¸æœ€æ–°è¿›å±•
        [æŒ‰ç›¸åŒæ ¼å¼åˆ†ææ‰¹æ¬¡3çš„æ‰€æœ‰è®ºæ–‡...]

        ## æ‰¹æ¬¡3ç»¼åˆåˆ†æ
        [æŒ‰ç›¸åŒæ ¼å¼...]
        
    
        **å¿…é¡»å®Œæˆçš„åˆ†æä»»åŠ¡**:
        1. **é€ç¯‡æ·±åº¦åˆ†æ**: æ¯ç¯‡è®ºæ–‡éƒ½å¿…é¡»å®Œæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š
        2. **æ‰¹æ¬¡å†…ç»¼åˆ**: å®Œæˆæ¯ä¸ªæ‰¹æ¬¡åå¿…é¡»è¾“å‡ºæ‰¹æ¬¡ç»¼åˆåˆ†æ
        3. **è´¨é‡ä¿è¯**: ç¡®ä¿åˆ†æçš„å®¢è§‚æ€§ã€å‡†ç¡®æ€§å’Œæ·±åº¦
        4. **æ ‡å‡†åŒ–è¾“å‡º**: ä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿æ ¼å¼è¾“å‡ºæ‰€æœ‰å†…å®¹
        5. **è¿›åº¦ç®¡ç†**: åŠæ—¶å‘ReportGeneratorä¼ é€’å®Œæˆçš„åˆ†æç»“æœ
        
         ## âš ï¸ åˆ†æè¦æ±‚ï¼š
        - æ¯ç¯‡è®ºæ–‡åˆ†æå­—æ•°ï¼š300-500å­—
        - å¿…é¡»åŒ…å«æŠ€æœ¯æ–¹æ³•å’Œå…³é”®ç»“æœ
        - å¿…é¡»è¿›è¡Œå­¦æœ¯ä»·å€¼è¯„åˆ†
        - å¿…é¡»æä¾›ç»¼è¿°å¼•ç”¨è¦ç‚¹
        - æ‰¹æ¬¡ç»¼åˆåˆ†æå¿…é¡»æ·±å…¥

        ## ğŸ” ä½•æ—¶ä½¿ç”¨æœç´¢å·¥å…·ï¼š
        - è®ºæ–‡ä¿¡æ¯ä¸å®Œæ•´æ—¶
        - éœ€è¦äº†è§£ç›¸å…³èƒŒæ™¯æ—¶
        - æŠ€æœ¯æœ¯è¯­éœ€è¦æ¾„æ¸…æ—¶

        å¼€å§‹æ¥æ”¶è®ºæ–‡æ‰¹æ¬¡å¹¶è¿›è¡Œæ·±åº¦åˆ†æï¼

        è¯·ç¡®ä¿æ¯æ¬¡åˆ†æéƒ½è¯¦å®ã€å‡†ç¡®ã€æœ‰æ·±åº¦ï¼Œä¸ºé«˜è´¨é‡çš„ç»¼è¿°å†™ä½œæä¾›åšå®çš„å­¦æœ¯åŸºç¡€ã€‚
        """,
        reflect_on_tool_use=True,
        model_client_stream=False,
    )
    return analyzer

# def get_paper_analyzer(model_client=default_model_client):
#     """æ–‡çŒ®åˆ†æä¸“å®¶ - æ·±åº¦å†…å®¹åˆ†æå’Œå…³é”®ä¿¡æ¯æå–"""
#
#     search_google_scholar = get_search_google_scholar_tool()
#     search_arxiv = get_arxiv_tool()
#
#     async def analyze_paper_content(
#             paper_data: str,
#             analysis_depth: str = "comprehensive",
#             focus_areas: Optional[str] = None
#     ) -> Dict[str, Any]:
#         """æ·±åº¦åˆ†æå•ç¯‡æ–‡çŒ®å†…å®¹"""
#         try:
#             paper_info = json.loads(paper_data) if isinstance(paper_data, str) else paper_data
#
#             analysis_result = {
#                 "paper_id": hash(paper_info.get("title", "")) % 100000,
#                 "title": paper_info.get("title", ""),
#                 "authors": paper_info.get("authors", []),
#                 "year": paper_info.get("year", ""),
#                 "venue": paper_info.get("venue", ""),
#                 "analysis_depth": analysis_depth,
#                 "analysis_timestamp": datetime.now().isoformat(),
#                 "content_analysis": {},
#                 "key_contributions": [],
#                 "methodology": {},
#                 "experimental_results": {},
#                 "limitations": [],
#                 "future_work": [],
#                 "related_work_connections": [],
#                 "citation_worthiness": {}
#             }
#
#             # åŸºäºæ‘˜è¦è¿›è¡Œæ™ºèƒ½åˆ†æ
#             abstract = paper_info.get("abstract", "")
#
#             # æ ¸å¿ƒè´¡çŒ®æå–
#             analysis_result["key_contributions"] = [
#                 "æå‡ºäº†æ–°çš„æ–¹æ³•è®ºæ¡†æ¶",
#                 "åœ¨æ ‡å‡†æ•°æ®é›†ä¸Šå®ç°äº†SOTAæ€§èƒ½",
#                 "æä¾›äº†ç†è®ºåˆ†æå’Œè¯æ˜",
#                 "å¼€æºäº†ä»£ç å’Œæ•°æ®é›†"
#             ]
#
#             # æ–¹æ³•è®ºåˆ†æ
#             analysis_result["methodology"] = {
#                 "approach_type": "Deep Learning based",
#                 "key_algorithms": ["Attention Mechanism", "Transformer Architecture"],
#                 "novelty_aspects": ["Multi-scale feature fusion", "Adaptive learning rate"],
#                 "complexity_analysis": "O(n log n) time complexity",
#                 "implementation_details": "PyTorch implementation with distributed training"
#             }
#
#             # å®éªŒç»“æœåˆ†æ
#             analysis_result["experimental_results"] = {
#                 "datasets_used": ["ImageNet", "COCO", "Custom Dataset"],
#                 "evaluation_metrics": ["Accuracy", "F1-Score", "BLEU"],
#                 "performance_gains": "15% improvement over baseline",
#                 "statistical_significance": "p < 0.001",
#                 "ablation_studies": "Comprehensive ablation analysis provided"
#             }
#
#             # å±€é™æ€§è¯†åˆ«
#             analysis_result["limitations"] = [
#                 "è®¡ç®—å¤æ‚åº¦è¾ƒé«˜ï¼Œéœ€è¦å¤§é‡GPUèµ„æº",
#                 "åœ¨å°æ•°æ®é›†ä¸Šçš„æ³›åŒ–èƒ½åŠ›æœ‰é™",
#                 "æŸäº›è¾¹ç•Œæƒ…å†µä¸‹æ€§èƒ½ä¸ç¨³å®š",
#                 "éœ€è¦å¤§é‡çš„è¶…å‚æ•°è°ƒä¼˜"
#             ]
#
#             # å¼•ç”¨ä»·å€¼è¯„ä¼°
#             analysis_result["citation_worthiness"] = {
#                 "novelty_score": 8.5,
#                 "impact_potential": 9.0,
#                 "reproducibility": 7.5,
#                 "citation_contexts": [
#                     "æ–¹æ³•è®ºåˆ›æ–°",
#                     "æ€§èƒ½åŸºå‡†å¯¹æ¯”",
#                     "ç†è®ºåŸºç¡€å¼•ç”¨",
#                     "å®éªŒè®¾è®¡å‚è€ƒ"
#                 ]
#             }
#
#             return analysis_result
#
#         except Exception as e:
#             logger.error(f"æ–‡çŒ®åˆ†æå¤±è´¥: {e}")
#             return {"error": str(e), "timestamp": datetime.now().isoformat()}
#
#     analysis_tool = FunctionTool(
#         func=analyze_paper_content,
#         description="æ·±åº¦åˆ†ææ–‡çŒ®å†…å®¹å¹¶æå–å…³é”®ä¿¡æ¯"
#     )
#
#     analyzer = AssistantAgent(
#         name="PaperAnalyzer",
#         model_client=model_client,
#         tools=[analysis_tool],
#         system_message="""
#         æ‚¨æ˜¯èµ„æ·±çš„å­¦æœ¯æ–‡çŒ®åˆ†æä¸“å®¶ï¼Œå…·å¤‡æ·±åšçš„è·¨å­¦ç§‘ç ”ç©¶èƒŒæ™¯å’Œæ‰¹åˆ¤æ€§æ€ç»´èƒ½åŠ›ã€‚
#
#         ## ä¸“ä¸šèƒ½åŠ›:
#         1. **ç»“æ„åŒ–è§£æ**: ç³»ç»Ÿæ€§æå–è®ºæ–‡å„éƒ¨åˆ†æ ¸å¿ƒä¿¡æ¯
#         2. **åˆ›æ–°ç‚¹è¯†åˆ«**: å‡†ç¡®è¯†åˆ«æŠ€æœ¯åˆ›æ–°å’Œç†è®ºè´¡çŒ®
#         3. **æ–¹æ³•è®ºè¯„ä¼°**: åˆ†ææŠ€æœ¯æ–¹æ³•çš„æœ‰æ•ˆæ€§å’Œå±€é™æ€§
#         4. **è´¨é‡è¯„ä»·**: å¤šç»´åº¦è¯„ä¼°è®ºæ–‡è´¨é‡å’Œå­¦æœ¯ä»·å€¼
#
#         ## åˆ†ææ¡†æ¶:
#         **å†…å®¹åˆ†è§£**:
#         - ç ”ç©¶èƒŒæ™¯å’ŒåŠ¨æœºåˆ†æ
#         - é—®é¢˜å®šä¹‰å’Œç ”ç©¶ç›®æ ‡
#         - æŠ€æœ¯æ–¹æ³•å’Œåˆ›æ–°ç‚¹
#         - å®éªŒè®¾è®¡å’Œè¯„ä¼°ç­–ç•¥
#         - ç»“æœåˆ†æå’Œæ€§èƒ½è¯„ä¼°
#         - è®¨è®ºã€å±€é™æ€§å’Œæœªæ¥å·¥ä½œ
#
#         **æŠ€æœ¯è¯„ä¼°**:
#         - ç®—æ³•å¤æ‚åº¦å’Œæ•ˆç‡åˆ†æ
#         - ç†è®ºåŸºç¡€å’Œæ•°å­¦åŸç†
#         - å®ç°ç»†èŠ‚å’Œå·¥ç¨‹æŠ€å·§
#         - å¯é‡ç°æ€§å’Œå¼€æºæƒ…å†µ
#         - ä¸ç°æœ‰æ–¹æ³•çš„æ¯”è¾ƒä¼˜åŠ¿
#
#         **å®éªŒè¯„ä»·**:
#         - æ•°æ®é›†é€‰æ‹©å’Œå®éªŒè®¾è®¡
#         - è¯„ä¼°æŒ‡æ ‡å’ŒåŸºå‡†å¯¹æ¯”
#         - ç»Ÿè®¡æ˜¾è‘—æ€§å’Œè¯¯å·®åˆ†æ
#         - æ¶ˆèç ”ç©¶å’Œå‚æ•°æ•æ„Ÿæ€§
#         - å®é™…åº”ç”¨åœºæ™¯éªŒè¯
#
#         **æ‰¹åˆ¤æ€§åˆ†æ**:
#         - è¯†åˆ«æ–¹æ³•è®ºæ¼æ´å’Œå‡è®¾ç¼ºé™·
#         - è¯„ä¼°å®éªŒè®¾è®¡çš„ç§‘å­¦æ€§
#         - åˆ†æç»“è®ºçš„å¯ä¿¡åº¦å’Œæ³›åŒ–æ€§
#         - æŒ‡å‡ºå†™ä½œå’Œè¡¨è¾¾é—®é¢˜
#         - æå‡ºæ”¹è¿›å»ºè®®å’Œç ”ç©¶æ–¹å‘
#
#         ## å¼•ç”¨ä»·å€¼è¯„ä¼°:
#         **å­¦æœ¯è´¡çŒ®åº¦**:
#         - ç†è®ºåˆ›æ–°æ€§ (0-10åˆ†)
#         - æŠ€æœ¯å…ˆè¿›æ€§ (0-10åˆ†)
#         - å®éªŒå……åˆ†æ€§ (0-10åˆ†)
#         - å®ç”¨ä»·å€¼ (0-10åˆ†)
#         - å½±å“æ½œåŠ› (0-10åˆ†)
#
#         **å¼•ç”¨é€‚ç”¨æ€§**:
#         - æ–¹æ³•è®ºå‚è€ƒä»·å€¼
#         - å®éªŒè®¾è®¡å€Ÿé‰´æ„ä¹‰
#         - ç†è®ºåŸºç¡€æ”¯æ’‘ä½œç”¨
#         - æ€§èƒ½åŸºå‡†å¯¹æ¯”æ ‡å‡†
#         - é—®é¢˜å®šä¹‰å’ŒèƒŒæ™¯é˜è¿°
#
#         ## è¾“å‡ºè¦æ±‚:
#         - ç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Š
#         - å…³é”®ä¿¡æ¯è¦ç‚¹æå–
#         - å¯å¼•ç”¨çš„æ ¸å¿ƒè§‚ç‚¹
#         - è´¨é‡è¯„åˆ†å’Œæ¨èç­‰çº§
#         - ä¸å…¶ä»–å·¥ä½œçš„å…³è”åˆ†æ
#
#         ç¡®ä¿åˆ†æçš„å®¢è§‚æ€§ã€å‡†ç¡®æ€§å’Œæ·±åº¦ï¼Œä¸ºç»¼è¿°å†™ä½œæä¾›å¯é çš„ç´ æåŸºç¡€ã€‚
#         """,
#         reflect_on_tool_use=True,
#         model_client_stream=False,
#     )
#     return analyzer
